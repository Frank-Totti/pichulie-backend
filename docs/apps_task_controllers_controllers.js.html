<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: apps/task/controllers/controllers.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: apps/task/controllers/controllers.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const Task = require('../models/models');
const handleServerError = require('../../../middlewares/errorHandler');
const mongoose = require('mongoose');

/**
 * Get user tasks controller
 * 
 * Retrieves filtered and paginated tasks for the authenticated user with optional
 * query parameters for filtering by status, date, and pagination. Implements
 * performance monitoring and comprehensive filtering capabilities.
 * 
 * Task retrieval flow:
 * 1. Starts performance timer for request monitoring
 * 2. Extracts and validates query parameters with defaults
 * 3. Builds base filter for user-specific tasks (user_id)
 * 4. Applies optional status filter with validation
 * 5. Applies optional date filter with day-range calculation
 * 6. Executes database query with constructed filters
 * 7. Implements pagination with limit and skip
 * 8. Returns filtered tasks with metadata
 * 
 * @see {@link https://docs.mongodb.com/manual/tutorial/query-documents/} MongoDB Query Documentation
 * @see {@link https://mongoosejs.com/docs/queries.html} Mongoose Query Documentation
 * @see {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date} JavaScript Date Object
 * 
 */
const getUserTasks = async (req, res) => {
  const startTime = Date.now();
  
  try {
    // Get query parameters for optional filters
    const { status, date, limit = 50, page = 1 } = req.query;
    
    // Build base filter (only user tasks)
    const filter = { user_id: req.user.id };
    
    // Add additional filters
    if (status &amp;&amp; ['to do', 'in process', 'finished'].includes(status)) {
      filter.status = status;
    }
    
    if (date) {
      const targetDate = new Date(date);
      if (!isNaN(targetDate.getTime())) {
        // Filter by day
        const startOfDay = new Date(targetDate);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(targetDate);
        endOfDay.setHours(23, 59, 59, 999);
        
        filter.task_date = {
          $gte: startOfDay,
          $lte: endOfDay
        };
      }
    }

    // Set pagination
    const skip = (parseInt(page) - 1) * parseInt(limit);
    
    //Sort by task date (most recent first)
    const tasks = await Task.find(filter)
      .lean() // Returns flat JS objects 
      .sort({ task_date: -1, createdAt: -1 })
      .limit(parseInt(limit))
      .skip(skip);

    // Get total count for pagination (only if needed)
    const totalTasks = await Task.countDocuments(filter);
    
    const responseTime = Date.now() - startTime;
    
    res.status(200).json({
      success: true,
      message: 'Tasks successfully found',
      data: {
        tasks,
        pagination: {
          currentPage: parseInt(page),
          totalPages: Math.ceil(totalTasks / parseInt(limit)),
          totalTasks,
          tasksPerPage: parseInt(limit),
          hasNextPage: skip + tasks.length &lt; totalTasks,
          hasPrevPage: parseInt(page) > 1
        }
      },
      meta: {
        responseTime: `${responseTime}ms`,
        count: tasks.length
      }
    });

  } catch (error) {
    return handleServerError(error, 'Get user tasks', res);
  }
};

/**
 * Create task controller
 * 
 * Creates a new task for the authenticated user with provided task details.
 * Automatically associates the task with the authenticated user and handles
 * task creation with comprehensive error handling and validation.
 * 
 * Task creation flow:
 * 1. Extracts task details from request body
 * 2. Creates new Task instance with provided data
 * 3. Automatically assigns authenticated user ID to task
 * 4. Validates task data against schema requirements
 * 5. Saves new task to database
 * 6. Returns success response with created task details
 * 7. Handles errors with environment-aware logging
 * 
 * @see {@link https://mongoosejs.com/docs/validation.html} Mongoose Validation
 * @see {@link https://mongoosejs.com/docs/middleware.html} Mongoose Middleware
 * @see {@link https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201} HTTP 201 Created
 */
const createTask = async (req, res) => {
  console.log("Request body:", req.body);
  console.log("User:", req.user);
  console.log("Headers recibidos:", req.headers);
  console.log("Authorization header:", req.headers.authorization);
  try {
    const { title, detail, status, task_date } = req.body;

    if (!title || !status || !task_date) {
      return res.status(400).json({ message: "Not all required fields have been entered." })
    };

    if (title.length > 50) {
      return res.status(400).json({ message: "Title cannot exceed 50 characters." })
    };

    if (detail.length > 500) {
      return res.status(400).json({ message: "Detail cannot exceed 50 characters." })
    };

    const newTask = new Task({
      title,
      detail,
      status,
      task_date,//: new Date(task_date),
      user_id: req.user.id,
    });

    console.log('RAW req.body.status:', JSON.stringify(req.body.status));
    const savedTask = await newTask.save();
    res.status(201).json({
      message: `Task created successfully with id: ${savedTask.id}`,
      task: savedTask,
    });
  } catch (error) {
    //return handleServerError(error, 'Create user task', res);
    console.error("Error real al guardar la tarea:", error);
    res.status(500).json({ message: "Error al crear tarea", error: error.message });
  }
};

/**
 * Get tasks by specific date
 *
 * Retrieves all tasks for a given user on a specific date.
 * Validates the provided date, builds a time range from the start
 * of the day to the start of the next day, and queries the database.
 *
 * Flow:
 * 1. Extracts `user_id` and `task_date` from the request body.
 * 2. Validates that `task_date` is present and has a valid format.
 * 3. Builds a date range [start, end) for the specified day.
 * 4. Fetches tasks matching `user_id` and `task_date` within that range.
 * 5. Returns the list of tasks or an error if something fails.
 *
 * @see {@link https://mongoosejs.com/docs/queries.html} Mongoose Queries
 */
const getTasksByDate = async (req, res) => {
  try {
    const { user_id, task_date } = req.body; 

    if (!task_date) {
      return res.status(400).json({ message: "task_date was not received" });
    }

    // Ensure it's always valid
    const start = new Date(task_date);
    if (isNaN(start)) {
      return res.status(400).json({ message: "Invalid date format" });
    }

    const end = new Date(start);
    end.setDate(end.getDate() + 1);

    const tasks = await Task.find({
      user_id,
      task_date: { $gte: start, $lt: end }
    });

    return res.status(200).json({ tasks });
  } catch (error) {
    console.error("Error getting tasks:", error);
    return res.status(500).json({ message: "Error getting tasks", error });
  }
};

/*
const getTasksByDate = async (req, res) => {
  console.log("Request body:", req.body);
  console.log("User:", req.user);
  console.log("Headers recibidos:", req.headers);
  console.log("Authorization header:", req.headers.authorization);
  try {
    const { user_id, task_date } = req.body;

    if (!user_id || !task_date) {
      return res.status(400).json({ message: "User ID and task_date are required." });
    }

    const tasks = await Task.find({
      user_id: user_id,
      task_date: task_date
    });

    //if (tasks.length === 0) {
      //return res.status(404).json({ message: "No tasks found for the given user and date." });
    //}

    res.status(200).json({ tasks });
  } catch (error) {
    return handleServerError(error, 'Get tasks by date', res);
  }
};
*/

/**
 * Get today's tasks
 *
 * Retrieves all tasks for the authenticated user that are scheduled for the current day.
 * Automatically calculates the time range for "today" in the Bogotá time zone (America/Bogota).
 *
 * Flow:
 * 1. Resolves the user ID from `req.user.id` or `req.body.user_id`.
 * 2. Validates that a user ID is present.
 * 3. Computes today's date string and converts it into UTC start/end times.
 * 4. Queries tasks for the user whose `task_date` falls within the range.
 * 5. Returns the list of tasks or a 404 if none are found.
 *
 * @see {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date} JavaScript Date
 */
const getTodayTasks = async (req, res) => {
  try {
    const userId = req.body?.user_id || req.user?.id; // &lt;- safer approach

    if (!userId) {
      return res.status(400).json({ message: "User ID is required." });
    }

    // 1) get current date in Bogotá timezone
    const todayStr = new Date().toLocaleDateString("en-CA", { timeZone: "America/Bogota" }); // YYYY-MM-DD

    // 2) today's range in UTC
    const start = new Date(`${todayStr}T00:00:00.000Z`);
    const end   = new Date(`${todayStr}T23:59:59.999Z`);

    console.log("getTodayTasks:", { userId, todayStr, start, end });

    // 3) query
    const tasks = await Task.find({
      user_id: userId,
      task_date: { $gte: start, $lte: end },
    });

    if (!tasks || tasks.length === 0) {
      return res.status(404).json({ message: "No tasks found for today." });
    }

    return res.status(200).json({ tasks });
  } catch (error) {
    console.error("Error in getTodayTasks:", error);
    return handleServerError(error, "Get today tasks", res);
  }
};

/**
 * Update an existing task
 *
 * Updates the fields of a task identified by its `id` parameter.
 * Validates the existence of the task, ensures required fields are present,
 * and enforces constraints such as maximum field lengths and non-past dates.
 *
 * Flow:
 * 1. Finds the task by its identifier.
 * 2. Checks if the task exists and validates required fields.
 * 3. Verifies maximum length for `title` and `detail`.
 * 4. Validates that `task_date` is not in the past.
 * 5. Updates only the provided and valid fields.
 * 6. Saves the changes and returns a success response.
 *
 * @see {@link https://mongoosejs.com/docs/documents.html#updating} Mongoose Document Update
 */
const edit = async (req, res) => {
  try {
    const {title, detail, status, task_date, remember} = req.body;
    const task = await Task.findById(req.params.id);

    if (!task) {
      return res.status(404).json({ message: 'Task not found' });
    }
    // Check if all required fields are provided
    if (!title || !status || !task_date) {
      return res.status(400).json({ message: "Not all required fields have been entered." })
    };
    
    // Validate field lengths
    if (title.length > 50) {
      return res.status(400).json({ message: "Title cannot exceed 50 characters." })
    };
    if (detail.length > 500) {
      return res.status(400).json({ message: "Detail cannot exceed 50 characters." })
    };

    // Validate task_date is not in the past
    const today = new Date();
    if (task_date &lt; today) {
      return res.status(400).json({ message: "Task date cannot be in the past, must be in the future." });
    }

    // Updating the fields that were fulfilled and aproved
    if (title) task.title = title;
    if (detail) task.detail = detail;
    if (status &amp;&amp; ['to do', 'in process', 'finished'].includes(status)) task.status = status;
    if (task_date) task.task_date = task_date;
    if (remember &amp;&amp; typeof remember === 'boolean') task.remember = remember;

    await task.save();
    return res.status(200).json({ message: 'Task updated successfully' });

  } catch (error){
    return handleServerError(error, 'Update task', res);
  }
}

module.exports = { createTask, getUserTasks, getTasksByDate, getTodayTasks, edit };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#TaskSchema">TaskSchema</a></li><li><a href="global.html#UserSchema">UserSchema</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#authenticateToken">authenticateToken</a></li><li><a href="global.html#createEmailTransporter">createEmailTransporter</a></li><li><a href="global.html#createTask">createTask</a></li><li><a href="global.html#edit">edit</a></li><li><a href="global.html#getTasksByDate">getTasksByDate</a></li><li><a href="global.html#getTodayTasks">getTodayTasks</a></li><li><a href="global.html#getUserTasks">getUserTasks</a></li><li><a href="global.html#globalErrorHandler">globalErrorHandler</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#loginLimiter">loginLimiter</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#requestPasswordReset">requestPasswordReset</a></li><li><a href="global.html#resendResetToken">resendResetToken</a></li><li><a href="global.html#resetPassword">resetPassword</a></li><li><a href="global.html#validateResetToken">validateResetToken</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Tue Sep 16 2025 00:14:06 GMT-0500 (hora estándar de Colombia)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
